name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      jwt_token_1:
        description: 'JWT Token 1'
        required: false
        type: string
      jwt_token_2:
        description: 'JWT Token 2'
        required: false
        type: string
      jwt_token_3:
        description: 'JWT Token 3'
        required: false
        type: string
      jwt_token_4:
        description: 'JWT Token 4'
        required: false
        type: string
      jwt_token_5:
        description: 'JWT Token 5'
        required: false
        type: string

jobs:
  deploy-to-huggingface:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Read version from file
      id: version
      run: echo "VERSION=$(cat version.txt | grep version= | cut -d= -f2)" >> $GITHUB_OUTPUT

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub
        pip install -r requirements.txt

    - name: Create Hugging Face Space structure
      run: |
        mkdir -p huggingface-space
        
        # Copy application files
        cp main.py huggingface-space/
        cp config_manager.py huggingface-space/
        cp requirements.txt huggingface-space/
        cp jetbrainsai.json huggingface-space/ || echo "jetbrainsai.json not found, skipping"
        cp client_api_keys.json huggingface-space/ || echo "client_api_keys.json not found, skipping"
        cp models.json huggingface-space/ || echo "models.json not found, skipping"
        
        # Create README for Hugging Face Space
        cat > huggingface-space/README.md << 'EOF'
        ---
        title: JetBrains AI API
        emoji: 🚀
        colorFrom: blue
        colorTo: purple
        sdk: docker
        pinned: false
        license: mit
        app_port: 8000
        ---

        # JetBrains AI API

        This is a JetBrains AI API service deployed on Hugging Face Spaces.

        ## Features

        - OpenAI and Anthropic API compatibility
        - JWT token authentication
        - Multiple model support
        - Environment variable configuration

        ## Configuration

        Configure your JWT tokens and API keys through the Hugging Face Spaces secrets:

        - `JWT_TOKEN_1` - `JWT_TOKEN_5`: Your JWT tokens
        - `OPENAI_API_KEY`: OpenAI API key (optional)
        - `ANTHROPIC_API_KEY`: Anthropic API key (optional)

        ## Usage

        Once deployed, the API will be available at your Hugging Face Space URL on port 8000.

        ## Version

        Version: ${{ steps.version.outputs.VERSION }}
        EOF

    - name: Create configuration script
      run: |
        cat > huggingface-space/process_config.py << 'EOF'
        import json
        import os

        # Load existing config or create new one
        try:
            with open('jetbrainsai.json', 'r') as f:
                config = json.load(f)
        except:
            config = {}

        # Process JWT_TOKEN environment variable (comma-separated format)
        jwt_token_env = os.environ.get('JWT_TOKEN', '')
        if jwt_token_env:
            tokens = [token.strip() for token in jwt_token_env.split(',') if token.strip()]
            if tokens:
                if 'clients' not in config:
                    config['clients'] = []
                
                # Clear existing clients and add new ones from environment
                config['clients'] = []
                for i, token in enumerate(tokens, 1):
                    config['clients'].append({
                        'name': f'client_{i}',
                        'token': token,
                        'enabled': True
                    })

        # Fallback: Process individual JWT_TOKEN_1, JWT_TOKEN_2, etc.
        if not jwt_token_env:
            for i in range(1, 6):
                token_key = f'JWT_TOKEN_{i}'
                if token_key in os.environ and os.environ[token_key]:
                    if 'clients' not in config:
                        config['clients'] = []
                    
                    # Find or create client entry
                    client_found = False
                    for client in config['clients']:
                        if client.get('name') == f'client_{i}':
                            client['token'] = os.environ[token_key]
                            client_found = True
                            break
                    
                    if not client_found:
                        config['clients'].append({
                            'name': f'client_{i}',
                            'token': os.environ[token_key],
                            'enabled': True
                        })

        # Save updated config
        with open('jetbrainsai.json', 'w') as f:
            json.dump(config, f, indent=2)
        EOF

    - name: Create startup script
      run: |
        cat > huggingface-space/start.sh << 'EOF'
        #!/bin/bash
        # Process environment variables to JSON configuration
        python3 process_config.py
        # Start the application
        python main.py
        EOF
        chmod +x huggingface-space/start.sh

    - name: Create Hugging Face Dockerfile
      run: |
        cat > huggingface-space/Dockerfile << 'EOF'
        FROM python:3.11-slim

        WORKDIR /app

        # Install system dependencies
        RUN apt-get update && apt-get install -y \
            gcc \
            curl \
            && rm -rf /var/lib/apt/lists/*

        # Copy requirements and install Python dependencies
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt

        # Copy application files
        COPY main.py .
        COPY config_manager.py .
        COPY process_config.py .
        COPY start.sh .
        COPY jetbrainsai.json* ./
        COPY client_api_keys.json* ./
        COPY models.json* ./

        # Create a non-root user and set permissions
        RUN useradd -m -u 1000 appuser && \
            chown -R appuser:appuser /app && \
            chmod +x start.sh

        # Switch to non-root user
        USER appuser

        # Expose port
        EXPOSE 8000

        # Set environment variables
        ENV PYTHONUNBUFFERED=1
        ENV DEBUG_MODE=false

        # Health check
        HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
            CMD curl -f http://localhost:8000/health || exit 1

        # Start the application
        CMD ["./start.sh"]
        EOF

    - name: Deploy to Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
      run: |
        if [ -z "$HF_TOKEN" ]; then
          echo "❌ HF_TOKEN secret not set. Please add your Hugging Face token to repository secrets."
          exit 1
        fi
        
        if [ -z "$SPACE_NAME" ]; then
          echo "❌ HF_SPACE_NAME secret not set. Please set your desired space name (e.g., username/jetbrainsai-api)."
          exit 1
        fi
        
        cd huggingface-space
        
        # Login to Hugging Face
        python -c "
        from huggingface_hub import HfApi
        import os
        
        api = HfApi()
        
        try:
            # Create or update the space
            api.create_repo(
                repo_id=os.environ['SPACE_NAME'],
                repo_type='space',
                space_sdk='docker',
                exist_ok=True,
                token=os.environ['HF_TOKEN']
            )
            print('✅ Space created/updated successfully')
            
            # Upload files
            api.upload_folder(
                folder_path='.',
                repo_id=os.environ['SPACE_NAME'],
                repo_type='space',
                token=os.environ['HF_TOKEN']
            )
            print('✅ Files uploaded successfully')
            
        except Exception as e:
            print(f'❌ Error: {e}')
            exit(1)
        "
        
        echo "🚀 Deployment completed!"
        echo "Your space will be available at: https://huggingface.co/spaces/$SPACE_NAME"
        echo ""
        echo "📝 Don't forget to configure secrets in your Hugging Face Space:"
        echo "   - JWT_TOKEN_1 through JWT_TOKEN_5"
        echo "   - OPENAI_API_KEY (optional)"
        echo "   - ANTHROPIC_API_KEY (optional)"